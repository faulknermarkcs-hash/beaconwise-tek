<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 820" font-family="Inter, -apple-system, Segoe UI, Arial, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#475569"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#16a34a"/>
    </marker>
    <filter id="shadow" x="-2%" y="-2%" width="104%" height="108%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.08"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1100" height="820" fill="#f8fafc" rx="12"/>

  <!-- Title -->
  <text x="550" y="40" text-anchor="middle" font-size="22" font-weight="700" fill="#0f172a">BeaconWise TEK — Architecture</text>
  <text x="550" y="62" text-anchor="middle" font-size="13" fill="#64748b">Five-Layer Deterministic Governance Pipeline + TE-CL Consensus</text>

  <!-- ════════════════ USER INPUT ════════════════ -->
  <rect x="40" y="90" width="180" height="50" rx="8" fill="#e2e8f0" filter="url(#shadow)"/>
  <text x="130" y="120" text-anchor="middle" font-size="14" font-weight="600" fill="#334155">User Input</text>

  <!-- Arrow down -->
  <line x1="130" y1="140" x2="130" y2="168" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ════════════════ LAYER 1: SAFETY (TSL) ════════════════ -->
  <rect x="30" y="170" width="400" height="110" rx="10" fill="#fff1f2" stroke="#fecdd3" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="50" y="195" font-size="14" font-weight="700" fill="#be123c">Layer 1 — Safety (TSL)</text>
  <text x="50" y="215" font-size="11" fill="#64748b">Two-stage input screening</text>

  <!-- Stage 1 -->
  <rect x="50" y="228" width="160" height="38" rx="6" fill="#ffffff" stroke="#fda4af" stroke-width="1"/>
  <text x="130" y="244" text-anchor="middle" font-size="11" font-weight="600" fill="#9f1239">Stage 1: Regex</text>
  <text x="130" y="258" text-anchor="middle" font-size="9" fill="#64748b">Pattern matching</text>

  <!-- Stage 2 -->
  <rect x="230" y="228" width="180" height="38" rx="6" fill="#ffffff" stroke="#fda4af" stroke-width="1"/>
  <text x="320" y="244" text-anchor="middle" font-size="11" font-weight="600" fill="#9f1239">Stage 2: Embeddings</text>
  <text x="320" y="258" text-anchor="middle" font-size="9" fill="#64748b">Cosine sim vs frozen exemplars</text>

  <!-- Arrow between stages -->
  <line x1="210" y1="247" x2="228" y2="247" stroke="#be123c" stroke-width="1.5" marker-end="url(#arrow-red)"/>

  <!-- BOUND exit -->
  <rect x="450" y="200" width="90" height="32" rx="6" fill="#dc2626" filter="url(#shadow)"/>
  <text x="495" y="221" text-anchor="middle" font-size="12" font-weight="700" fill="#ffffff">BOUND</text>
  <line x1="430" y1="216" x2="448" y2="216" stroke="#dc2626" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="495" y="247" text-anchor="middle" font-size="9" fill="#dc2626">unsafe → blocked</text>

  <!-- Arrow down from Layer 1 -->
  <line x1="230" y1="280" x2="230" y2="310" stroke="#16a34a" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="244" y="300" font-size="9" fill="#16a34a" font-weight="600">safe ✓</text>

  <!-- ════════════════ LAYER 2: TSV ════════════════ -->
  <rect x="30" y="312" width="400" height="90" rx="10" fill="#eff6ff" stroke="#bfdbfe" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="50" y="337" font-size="14" font-weight="700" fill="#1e40af">Layer 2 — Transparent System Voice (TSV)</text>
  <text x="50" y="355" font-size="11" fill="#64748b">Bayesian belief tracking · 5 skills · Evidence strength-capping</text>

  <rect x="50" y="365" width="120" height="26" rx="5" fill="#ffffff" stroke="#93c5fd" stroke-width="1"/>
  <text x="110" y="382" text-anchor="middle" font-size="10" fill="#1e40af">Beliefs [0–1]</text>

  <rect x="180" y="365" width="100" height="26" rx="5" fill="#ffffff" stroke="#93c5fd" stroke-width="1"/>
  <text x="230" y="382" text-anchor="middle" font-size="10" fill="#1e40af">E0–E3 Evidence</text>

  <rect x="290" y="365" width="120" height="26" rx="5" fill="#ffffff" stroke="#93c5fd" stroke-width="1"/>
  <text x="350" y="382" text-anchor="middle" font-size="10" fill="#1e40af">7-day Decay</text>

  <!-- DEFER exit -->
  <rect x="450" y="332" width="90" height="32" rx="6" fill="#f59e0b" filter="url(#shadow)"/>
  <text x="495" y="353" text-anchor="middle" font-size="12" font-weight="700" fill="#ffffff">DEFER</text>
  <line x1="430" y1="348" x2="448" y2="348" stroke="#f59e0b" stroke-width="2"/>
  <text x="495" y="378" text-anchor="middle" font-size="9" fill="#92400e">high-stakes, no E3</text>

  <!-- Arrow down from Layer 2 -->
  <line x1="230" y1="402" x2="230" y2="425" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ════════════════ LAYER 4: RIL (Gates) ════════════════ -->
  <rect x="30" y="427" width="400" height="110" rx="10" fill="#fefce8" stroke="#fde68a" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="50" y="452" font-size="14" font-weight="700" fill="#a16207">Layer 4 — Routing &amp; Interaction (RIL)</text>
  <text x="50" y="470" font-size="11" fill="#64748b">HMAC tokens · Nonce replay detection · Revision-in-place</text>

  <rect x="50" y="482" width="110" height="40" rx="6" fill="#ffffff" stroke="#fbbf24" stroke-width="1"/>
  <text x="105" y="498" text-anchor="middle" font-size="10" font-weight="600" fill="#92400e">REFLECT</text>
  <text x="105" y="512" text-anchor="middle" font-size="9" fill="#64748b">Confirm gate</text>

  <rect x="170" y="482" width="110" height="40" rx="6" fill="#ffffff" stroke="#fbbf24" stroke-width="1"/>
  <text x="225" y="498" text-anchor="middle" font-size="10" font-weight="600" fill="#92400e">SCAFFOLD</text>
  <text x="225" y="512" text-anchor="middle" font-size="9" fill="#64748b">Approve gate</text>

  <rect x="290" y="482" width="120" height="40" rx="6" fill="#ffffff" stroke="#fbbf24" stroke-width="1"/>
  <text x="350" y="498" text-anchor="middle" font-size="10" font-weight="600" fill="#92400e">Crypto Binding</text>
  <text x="350" y="512" text-anchor="middle" font-size="9" fill="#64748b">Token · Nonce · HMAC</text>

  <!-- Arrow between gates -->
  <line x1="160" y1="502" x2="168" y2="502" stroke="#a16207" stroke-width="1"/>

  <!-- Arrow down from RIL -->
  <line x1="230" y1="537" x2="230" y2="560" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ════════════════ LAYER 3: TDM ════════════════ -->
  <rect x="30" y="562" width="400" height="90" rx="10" fill="#f0fdf4" stroke="#bbf7d0" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="50" y="587" font-size="14" font-weight="700" fill="#15803d">Layer 3 — Transparent Dialogue Manager (TDM)</text>
  <text x="50" y="605" font-size="11" fill="#64748b">Profile-adaptive generation · Retry loops · Alignment validation</text>

  <rect x="50" y="615" width="90" height="26" rx="5" fill="#ffffff" stroke="#86efac" stroke-width="1"/>
  <text x="95" y="632" text-anchor="middle" font-size="10" fill="#15803d">FAST</text>

  <rect x="150" y="615" width="100" height="26" rx="5" fill="#ffffff" stroke="#86efac" stroke-width="1"/>
  <text x="200" y="632" text-anchor="middle" font-size="10" fill="#15803d">STANDARD</text>

  <rect x="260" y="615" width="150" height="26" rx="5" fill="#ffffff" stroke="#86efac" stroke-width="1"/>
  <text x="335" y="632" text-anchor="middle" font-size="10" fill="#15803d">HIGH_ASSURANCE</text>

  <!-- Arrow down from TDM -->
  <line x1="230" y1="652" x2="230" y2="676" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ════════════════ LAYER 5: EPACK ════════════════ -->
  <rect x="30" y="678" width="400" height="80" rx="10" fill="#faf5ff" stroke="#e9d5ff" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="50" y="703" font-size="14" font-weight="700" fill="#7c3aed">Layer 5 — EPACK Audit Chain</text>
  <text x="50" y="721" font-size="11" fill="#64748b">Hash-chained records · Provenance manifests · Recursive redaction</text>

  <rect x="50" y="733" width="110" height="18" rx="4" fill="#ffffff" stroke="#c4b5fd" stroke-width="1"/>
  <text x="105" y="746" text-anchor="middle" font-size="9" fill="#7c3aed">seq → hash → prev</text>

  <rect x="170" y="733" width="80" height="18" rx="4" fill="#ffffff" stroke="#c4b5fd" stroke-width="1"/>
  <text x="210" y="746" text-anchor="middle" font-size="9" fill="#7c3aed">JSONL disk</text>

  <rect x="260" y="733" width="80" height="18" rx="4" fill="#ffffff" stroke="#c4b5fd" stroke-width="1"/>
  <text x="300" y="746" text-anchor="middle" font-size="9" fill="#7c3aed">In-memory</text>

  <rect x="350" y="733" width="60" height="18" rx="4" fill="#ffffff" stroke="#c4b5fd" stroke-width="1"/>
  <text x="380" y="746" text-anchor="middle" font-size="9" fill="#7c3aed">Redact</text>

  <!-- ════════════════ OUTPUT ════════════════ -->
  <line x1="230" y1="758" x2="230" y2="790" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="140" y="790" width="180" height="24" rx="6" fill="#e2e8f0"/>
  <text x="230" y="807" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">Governed Output</text>

  <!-- ════════════════ TE-CL CONSENSUS (right panel) ════════════════ -->
  <rect x="580" y="90" width="490" height="660" rx="12" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="825" y="120" text-anchor="middle" font-size="16" font-weight="700" fill="#0f172a">TE-CL Consensus Layer</text>
  <text x="825" y="140" text-anchor="middle" font-size="11" fill="#64748b">Multi-model orchestration with scope gating</text>

  <!-- Verification -->
  <rect x="610" y="160" width="430" height="80" rx="8" fill="#ecfdf5" stroke="#a7f3d0" stroke-width="1"/>
  <text x="630" y="182" font-size="12" font-weight="700" fill="#065f46">Credential Verification</text>
  <text x="630" y="198" font-size="10" fill="#64748b">File-backed stub → VerificationContext</text>
  <text x="630" y="214" font-size="10" fill="#64748b">Fail-closed: missing / expired / not found → PUBLIC_CONTEXT (level 1)</text>
  <text x="630" y="230" font-size="10" fill="#064e3b">4 paths tested: missing file · user not found · expired · success</text>

  <!-- Config Selection -->
  <rect x="610" y="256" width="430" height="76" rx="8" fill="#f0f9ff" stroke="#bae6fd" stroke-width="1"/>
  <text x="630" y="278" font-size="12" font-weight="700" fill="#0c4a6e">Config Selection</text>
  <text x="630" y="294" font-size="10" fill="#64748b">role_level 1 (public) → FAST preset</text>
  <text x="630" y="308" font-size="10" fill="#64748b">role_level 2 (nurse) → HIGH_ASSURANCE preset</text>
  <text x="630" y="322" font-size="10" fill="#64748b">role_level 3+ (physician/specialist) → CONSENSUS preset</text>

  <!-- Primary Model -->
  <rect x="610" y="348" width="200" height="60" rx="8" fill="#fef3c7" stroke="#fde68a" stroke-width="1"/>
  <text x="710" y="372" text-anchor="middle" font-size="12" font-weight="700" fill="#92400e">Primary Model</text>
  <text x="710" y="388" text-anchor="middle" font-size="10" fill="#78350f">Anthropic / OpenAI</text>
  <text x="710" y="400" text-anchor="middle" font-size="9" fill="#64748b">adapter-based</text>

  <!-- Validator Model -->
  <rect x="840" y="348" width="200" height="60" rx="8" fill="#fef3c7" stroke="#fde68a" stroke-width="1"/>
  <text x="940" y="372" text-anchor="middle" font-size="12" font-weight="700" fill="#92400e">Validator Model</text>
  <text x="940" y="388" text-anchor="middle" font-size="10" fill="#78350f">Cross-check</text>
  <text x="940" y="400" text-anchor="middle" font-size="9" fill="#64748b">parse + repair</text>

  <!-- Arrow between models -->
  <line x1="810" y1="378" x2="838" y2="378" stroke="#92400e" stroke-width="1.5" stroke-dasharray="4,3"/>

  <!-- Schema Validation -->
  <rect x="610" y="424" width="430" height="56" rx="8" fill="#f5f3ff" stroke="#ddd6fe" stroke-width="1"/>
  <text x="630" y="446" font-size="12" font-weight="700" fill="#5b21b6">Pydantic Schema Validation</text>
  <text x="630" y="462" font-size="10" fill="#64748b">PrimaryOutput · SynthesizerOutput · strict JSON with repair loop</text>
  <text x="630" y="474" font-size="9" fill="#6d28d9">max_repair_attempts: 1 (FAST) · 2 (HIGH_ASSURANCE) · 2 (CONSENSUS)</text>

  <!-- Scope Gate -->
  <rect x="610" y="496" width="430" height="100" rx="8" fill="#fff1f2" stroke="#fecdd3" stroke-width="1"/>
  <text x="630" y="518" font-size="12" font-weight="700" fill="#be123c">Scope Gate (Post-Generation)</text>
  <text x="630" y="536" font-size="10" fill="#64748b">Compiled regex rules with min_level thresholds per pattern</text>

  <rect x="630" y="548" width="70" height="22" rx="4" fill="#dcfce7"/>
  <text x="665" y="563" text-anchor="middle" font-size="10" font-weight="600" fill="#166534">PASS</text>

  <rect x="710" y="548" width="85" height="22" rx="4" fill="#fef3c7"/>
  <text x="752" y="563" text-anchor="middle" font-size="10" font-weight="600" fill="#92400e">REWRITE</text>

  <rect x="805" y="548" width="80" height="22" rx="4" fill="#fecdd3"/>
  <text x="845" y="563" text-anchor="middle" font-size="10" font-weight="600" fill="#be123c">REFUSE</text>

  <text x="630" y="590" font-size="9" fill="#64748b">Level 3+ physician → PASS | Level 2 nurse → REWRITE | Level 1 public → REFUSE</text>

  <!-- Ledger Events -->
  <rect x="610" y="612" width="430" height="56" rx="8" fill="#faf5ff" stroke="#e9d5ff" stroke-width="1"/>
  <text x="630" y="634" font-size="12" font-weight="700" fill="#7c3aed">EPACK Ledger Events</text>
  <text x="630" y="650" font-size="10" fill="#64748b">tecl.verification.* · tecl.scope_gate.pass · tecl.scope_gate.violation</text>
  <text x="630" y="662" font-size="9" fill="#7c3aed">Every decision logged with payload, role_level, domain, violations</text>

  <!-- Tool Sandbox (bottom right) -->
  <rect x="610" y="684" width="200" height="50" rx="8" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
  <text x="710" y="706" text-anchor="middle" font-size="11" font-weight="600" fill="#334155">Tool Sandbox</text>
  <text x="710" y="720" text-anchor="middle" font-size="9" fill="#64748b">AST-based calc · No eval()</text>

  <!-- Profile Escalation (bottom right) -->
  <rect x="840" y="684" width="200" height="50" rx="8" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
  <text x="940" y="706" text-anchor="middle" font-size="11" font-weight="600" fill="#334155">Profile Escalation</text>
  <text x="940" y="720" text-anchor="middle" font-size="9" fill="#64748b">FAST ↔ STANDARD ↔ HIGH</text>

  <!-- Connecting arrow: main pipeline → consensus -->
  <line x1="430" y1="610" x2="578" y2="380" stroke="#475569" stroke-width="1.5" stroke-dasharray="6,4" marker-end="url(#arrow)"/>
  <text x="490" y="485" font-size="10" fill="#475569" transform="rotate(-28, 490, 485)">LLM call</text>

  <!-- Connecting arrow: consensus → EPACK -->
  <line x1="578" y1="640" x2="432" y2="718" stroke="#7c3aed" stroke-width="1.5" stroke-dasharray="6,4"/>
  <text x="495" y="670" font-size="10" fill="#7c3aed" transform="rotate(18, 495, 670)">audit events</text>

  <!-- Version badge -->
  <rect x="940" y="90" width="120" height="24" rx="12" fill="#0f172a"/>
  <text x="1000" y="107" text-anchor="middle" font-size="11" font-weight="600" fill="#ffffff">TEK v9</text>
</svg>
